var E=Object.defineProperty;var b=(i,e,t)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var o=(i,e,t)=>b(i,typeof e!="symbol"?e+"":e,t);/* empty css             *//* empty css                 *//* empty css                  */import{r as m,o as B,d as g,v as w,w as c,E as T,a as h,f,c as A,g as M,k as P,b as C,t as x,e as R}from"./index-BrD9HEJJ.js";class D{constructor(e){o(this,"chunks");o(this,"onEnd");o(this,"onSpeakChange");o(this,"onStreamChange");o(this,"stream");o(this,"mediaRecorder");o(this,"audioContext");o(this,"mediaStreamSource");o(this,"processor");o(this,"mimeType");o(this,"isCancel");const{onEnd:t,onSpeakChange:a,onStreamChange:s,mimeType:n}=e;this.chunks=[],this.onEnd=t,this.onSpeakChange=a,this.onStreamChange=s,this.stream=null,this.mediaRecorder=null,this.audioContext=null,this.mediaStreamSource=null,this.processor=null,this.isCancel=!1,this.mimeType=n||"audio/mp4"}async start(){this.isCancel=!1,this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext,this.mediaStreamSource=this.audioContext.createMediaStreamSource(this.stream),this.processor=this.audioContext.createScriptProcessor(2048,1,1),this.processor.onaudioprocess=e=>{var n,r;let t=e.inputBuffer.getChannelData(0);const a=[];for(let u=0;u<t.length;u++)a.push(t[u]);let s=Math.max.apply(null,a);this.isCancel||((n=this.onSpeakChange)==null||n.call(this,s),(r=this.onStreamChange)==null||r.call(this,t))},this.mediaStreamSource.connect(this.processor),this.processor.connect(this.audioContext.destination),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:this.mimeType}),this.mediaRecorder.ondataavailable=e=>{this.chunks.push(e.data)},this.mediaRecorder.onstop=()=>{var e,t;this.isCancel||((e=this.onEnd)==null||e.call(this,[...this.chunks]),(t=this.onSpeakChange)==null||t.call(this,0)),this.chunks=[]},this.mediaRecorder.start()}async stop(){this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.audioContext&&(await this.audioContext.close(),this.audioContext=null),this.mediaStreamSource=null,this.processor=null}async cancel(){this.isCancel=!0,await this.stop()}}const N=i=>{const{onEnd:e,onSpeakChange:t}=i,a=m();return B(()=>{a.value=new D({onEnd:s=>{const n=new Blob(s,{type:"audio/webm"}),r=new File([n],"record.webm",{type:"audio/webm"});e==null||e(r)},onSpeakChange:s=>{t==null||t(s)}})}),{start:()=>{var s;return(s=a.value)==null?void 0:s.start()},stop:()=>{var s;return(s=a.value)==null?void 0:s.stop()},cancel:()=>{var s;return(s=a.value)==null?void 0:s.cancel()}}};class V{constructor(e){o(this,"audioBuffer");o(this,"audioContext");o(this,"source");o(this,"startTime");o(this,"offset");o(this,"rate");o(this,"isEndByStop");o(this,"onEnd");o(this,"onReady");const{arrayBuffer:t,rate:a=1,onEnd:s,onReady:n}=e;this.audioContext=new AudioContext,this.rate=a,this.onEnd=s,this.onReady=n,this.isEndByStop=!1,this.startTime=0,this.offset=0,this.audioBuffer=null,this.source=null,this.audioContext.decodeAudioData(t).then(r=>{var u;this.audioBuffer=r,(u=this.onReady)==null||u.call(this)})}start(){this.isEndByStop=!1,this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.playbackRate.value=this.rate||1,this.source.connect(this.audioContext.destination),this.source.onended=()=>{var e;this.isEndByStop?this.offset=this.audioContext.currentTime-this.startTime+this.offset:this.offset=0,(e=this.onEnd)==null||e.call(this)},this.source.start(0,this.offset),this.startTime=this.audioContext.currentTime}stop(){this.source&&(this.isEndByStop=!0,this.source.stop(),this.source.disconnect(this.audioContext.destination),this.source=null)}}const F={key:0},O=g({__name:"index",setup(i){const e=m(),t=m(),a=m(!1),s=m(),{start:n,stop:r}=N({onEnd:l=>{e.value=l,s.value.src=URL.createObjectURL(l)}}),u=()=>{e.value&&e.value.arrayBuffer().then(l=>{t.value=new V({arrayBuffer:l,rate:1,onEnd:()=>{console.log("播放结束")},onReady:()=>{t.value.start()}})})},_=()=>{a.value=!0,e.value=void 0,n()},k=()=>{a.value=!1,r()};return(l,d)=>{const p=P,S=T;return R(),w(S,{direction:"vertical",size:"15"},{default:c(()=>{var y,v;return[d[3]||(d[3]=h("h1",null,"Audio Record & Play",-1)),f(S,null,{default:c(()=>[f(p,{onClick:_,disabled:a.value},{default:c(()=>d[0]||(d[0]=[C("Start Record")])),_:1,__:[0]},8,["disabled"]),f(p,{onClick:k,disabled:!a.value},{default:c(()=>d[1]||(d[1]=[C("End Record")])),_:1,__:[1]},8,["disabled"]),f(p,{onClick:u,disabled:!e.value},{default:c(()=>d[2]||(d[2]=[C("Play Audio Without Html Audio Tag")])),_:1,__:[2]},8,["disabled"])]),_:1}),e.value?(R(),A("div",F,[h("span",null,"文件名："+x((y=e.value)==null?void 0:y.name),1),h("span",null,"文件大小："+x((v=e.value)==null?void 0:v.size)+"B",1)])):M("",!0),h("div",null,[h("audio",{ref_key:"audioRef",ref:s,controls:""},null,512)])]}),_:1,__:[3]})}}});export{O as default};
